<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Listado de Decretos Supremos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="decreto-supremo.css" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@100" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/paginationjs/2.1.5/pagination.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"></head>
<body>
  <header class="header">
      <div class="logo">
        <img src="/img/logomt.png" alt="logo" loading="lazy">
      </div>
      <div class="dropdown">
            <button class="dropdown__toggle">
                <span class="material-symbols-outlined">account_circle</span>
                <span class="dropdown__name">Moises Yance</span>
                <span class="material-symbols-outlined">keyboard_arrow_down</span>
            </button>
            <ul class="dropdown__menu">
                <li><a href="#">Perfil</a></li>
                <li><a href="#">Configuración</a></li>
                <li><a href="#">Cerrar sesión</a></li>
            </ul>
       </div>
  </header>
  <div class="container">
    <div>
      <div class="title">
        <span>Listado de Decretos Supremos</span>
      </div>

      <div class="table-wrap" id="tableWrap" role="region" aria-label="Tabla de decretos">
        <table class="data-table">
          <thead>
            <tr>
              <th>Num DS</th>
              <th>Tipo Peligro</th>
              <th>Fecha Inicio</th>
              <th>Fecha Fin</th>
              <th class="col-actions">Opciones</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div id="emptyState" class="empty" style="display:none">
        <div style="font-weight:700; margin-bottom:6px;">No se encontraron registros.</div>
        <div class="muted">Cuando existan Decretos Supremos aparecerán aquí.</div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div id="modalBackdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle" aria-describedby="modalDesc">
      <div class="modal-head" id="modalTitle">Alerta</div>
      <div class="modal-body" id="modalDesc">¿Desea eliminar el DS N° <span id="dsNumero"></span>?</div>
      <div class="modal-actions">
        <button class="btn btn-secondary" id="btnCancelar">Cancelar</button>
        <button class="btn btn-danger" id="btnEliminar">Eliminar</button>
      </div>
    </div>
  </div>

  <script>
    // ===========================
    // Configuración / Datos demo
    // ===========================
    const USER_BASE_URL = "/decreto-supremo-asignar.html";

    /** Datos de ejemplo (puedes reemplazar por tu fetch/JSON real) */
    let decretos = [
      { id: 1, nrm: "004-2025-PCM", tipo_peligro: "Inundación", fecha_inicio: "2025-02-20", fecha_fin: "2025-03-20" },
      { id: 2, nrm: "018-2025-PCM", tipo_peligro: "Deslizamiento", fecha_inicio: "2025-04-01", fecha_fin: "2025-04-30" },
      { id: 3, nrm: "021-2025-PCM", tipo_peligro: "Sequía", fecha_inicio: "2025-05-10", fecha_fin: "2025-06-10" },
      { id: 4, nrm: "025-2025-PCM", tipo_peligro: "Helada", fecha_inicio: "2025-06-15", fecha_fin: "2025-07-15" }
    ];

    // ===========================
    // Render de tabla
    // ===========================
    const tbody = document.getElementById('tbody');
    const emptyState = document.getElementById('emptyState');

    function renderTable() {
      tbody.innerHTML = '';
      if (!decretos.length) {
        emptyState.style.display = 'block';
        return;
      }
      emptyState.style.display = 'none';

      decretos.forEach(decreto => {
        const tr = document.createElement('tr');

        tr.innerHTML = `
          <td>${escapeHtml(decreto.nrm)}</td>
          <td>${escapeHtml(decreto.tipo_peligro)}</td>
          <td>${formatDate(decreto.fecha_inicio)}</td>
          <td>${formatDate(decreto.fecha_fin)}</td>
          <td class="col-actions">
            <button class="btn btn-danger" data-action="eliminar" data-id="${decreto.id}">
              <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-trash"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 7l16 0" /><path d="M10 11l0 6" /><path d="M14 11l0 6" /><path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12" /><path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3" /></svg>
            </button>
            <a class="btn" data-action="usuario" href="${USER_BASE_URL}?nrm=${decreto.nrm}" rel="noopener">
              <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-users"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 7m-4 0a4 4 0 1 0 8 0a4 4 0 1 0 -8 0" /><path d="M3 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" /><path d="M16 3.13a4 4 0 0 1 0 7.75" /><path d="M21 21v-2a4 4 0 0 0 -3 -3.85" /></svg>
            </a>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // ===========================
    // Utilidades
    // ===========================
    function formatDate(s){
      if(!s) return '';
      // Mostrar YYYY-MM-DD como DD/MM/YYYY
      const [y,m,d] = s.split('-');
      if(y && m && d) return `${d}/${m}/${y}`;
      return s;
    }
    function escapeHtml(str){
      return String(str)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#39;");
    }

    // ===========================
    // Modal (abrir/cerrar/confirmar)
    // ===========================
    const modalBackdrop = document.getElementById('modalBackdrop');
    const dsNumero = document.getElementById('dsNumero');
    const btnCancelar = document.getElementById('btnCancelar');
    const btnEliminar = document.getElementById('btnEliminar');

    let selectedId = null;
    let selectedNrm = '';

    function openModal(id, nrm){
      selectedId = id;
      selectedNrm = nrm || '';
      dsNumero.textContent = nrm || '';
      modalBackdrop.classList.add('backdrop-open');
      modalBackdrop.querySelector('.modal').classList.add('open');
      modalBackdrop.setAttribute('aria-hidden','false');
      // Trampa de foco simple
      btnCancelar.focus();
    }
    function closeModal(){
      modalBackdrop.classList.remove('backdrop-open');
      modalBackdrop.querySelector('.modal').classList.remove('open');
      modalBackdrop.setAttribute('aria-hidden','true');
      selectedId = null;
      selectedNrm = '';
    }

    // Clic fuera del modal cierra
    modalBackdrop.addEventListener('click', (e)=>{
      if(e.target === modalBackdrop) closeModal();
    });
    // Escape cierra
    document.addEventListener('keydown', (e)=>{
      if(e.key === 'Escape' && modalBackdrop.classList.contains('backdrop-open')){
        closeModal();
      }
    });
    btnCancelar.addEventListener('click', closeModal);

    btnEliminar.addEventListener('click', ()=>{
      if(selectedId != null){
        decretos = decretos.filter(x => x.id !== selectedId);
        renderTable();
      }
      closeModal();
    });

    // ===========================
    // Delegación de eventos tabla
    // ===========================
    tbody.addEventListener('click', (e)=>{
      const btn = e.target.closest('button, a');
      if(!btn) return;

      const action = btn.dataset.action;
      if(action === 'eliminar'){
        const id = Number(btn.dataset.id);
        const dec = decretos.find(x => x.id === id);
        openModal(id, dec?.nrm);
      }
      // 'usuario' es enlace externo <a>, no requiere JS
    });

    // Inicializar
    renderTable();
  </script>
  <script src="header.js"></script>
</body>
</html>
